{% extends "base.html" %}

{% block title %}Encrypt Files - PGP Web Application{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-lock me-2"></i>Encrypt Files
            </h2>
        </div>
    </div>

    <div class="row">
        <!-- File Upload Section -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-cloud-upload me-2"></i>Upload File
                    </h5>
                </div>
                <div class="card-body">
                    <div class="dropzone" id="fileDropzone" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">Drop files here or click to upload</h5>
                        <p class="text-muted mb-0">Maximum file size: 16MB</p>
                        <p class="small text-muted">Supported formats: PDF, DOC, TXT, IMG, ZIP, etc.</p>
                        <input type="file" id="fileInput" class="d-none" accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.zip">
                    </div>
                    
                    <div id="uploadProgress" class="mt-3 d-none">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Uploading file...</small>
                    </div>
                    
                    <div id="uploadedFile" class="mt-3 d-none">
                        <div class="alert alert-success d-flex align-items-center">
                            <i class="bi bi-check-circle me-2"></i>
                            <div class="flex-grow-1">
                                <strong id="uploadedFileName"></strong><br>
                                <small id="uploadedFileSize" class="text-muted"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeUploadedFile()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recipients Selection -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>Select Recipients
                    </h5>
                </div>
                <div class="card-body">
                    {% if public_keys %}
                        <div class="mb-3">
                            <label class="form-label">Available Public Keys</label>
                            <div class="recipient-list" style="max-height: 300px; overflow-y: auto;">
                                {% for key in public_keys %}
                                <div class="form-check mb-2 p-3 border rounded">
                                    <input class="form-check-input" type="checkbox" id="key_{{ key.keyid }}" 
                                           value="{{ key.keyid }}" name="recipients">
                                    <label class="form-check-label w-100" for="key_{{ key.keyid }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong class="d-block">
                                                    {% if key.uids %}
                                                        {{ key.uids[0] }}
                                                    {% else %}
                                                        Key ID: {{ key.keyid }}
                                                    {% endif %}
                                                </strong>
                                                <small class="text-muted d-block">
                                                    <code>{{ key.keyid }}</code> | {{ key.type }} {{ key.length }} bits
                                                </small>
                                                {% if key.expires %}
                                                    <small class="text-warning">
                                                        <i class="bi bi-clock me-1"></i>Expires: {{ key.expires[:10] }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                            <span class="badge bg-{{ 'success' if key.trust == 'ultimate' else 'warning' if key.trust == 'full' else 'secondary' }}">
                                                {{ key.trust or 'unknown' }}
                                            </span>
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllRecipients()">
                                <i class="bi bi-check-all me-1"></i>Select All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllRecipients()">
                                <i class="bi bi-x-circle me-1"></i>Clear All
                            </button>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-key display-4 text-muted"></i>
                            <h5 class="mt-3 text-muted">No Public Keys Available</h5>
                            <p class="text-muted">You need public keys to encrypt files for recipients.</p>
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="{{ url_for('main.generate_key') }}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-2"></i>Generate Key Pair
                                </a>
                                <a href="{{ url_for('main.keys') }}" class="btn btn-outline-primary">
                                    <i class="bi bi-download me-2"></i>Import Key
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Encryption Control -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-lock me-2"></i>Encryption Options
                    </h5>
                </div>
                <div class="card-body">
                    <div id="encryptionStatus" class="mb-3">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Please upload a file and select at least one recipient to begin encryption.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3 align-items-center">
                        <button id="encryptBtn" type="button" class="btn btn-success btn-lg" onclick="encryptFile()" disabled>
                            <i class="bi bi-lock me-2"></i>Encrypt File
                        </button>
                        
                        <div id="encryptionProgress" class="d-none">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                <span>Encrypting file...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Encrypted File Result -->
    <div id="encryptedFileResult" class="row mt-4 d-none">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>File Encrypted Successfully
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 id="encryptedFileName" class="mb-1"></h6>
                            <small id="encryptedFileSize" class="text-muted"></small>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="downloadEncryptedFile()">
                                <i class="bi bi-download me-2"></i>Download
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteEncryptedFile()">
                                <i class="bi bi-trash me-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let uploadedFileName = '';
let encryptedFileName = '';

// File upload handling
document.getElementById('fileInput').addEventListener('change', handleFileSelect);

// Drag and drop handling
const dropzone = document.getElementById('fileDropzone');
dropzone.addEventListener('dragover', handleDragOver);
dropzone.addEventListener('drop', handleDrop);
dropzone.addEventListener('dragenter', handleDragEnter);
dropzone.addEventListener('dragleave', handleDragLeave);

// Recipients change handling
document.querySelectorAll('input[name="recipients"]').forEach(checkbox => {
    checkbox.addEventListener('change', updateEncryptionStatus);
});

function handleDragOver(e) {
    e.preventDefault();
}

function handleDragEnter(e) {
    e.preventDefault();
    dropzone.classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    if (!dropzone.contains(e.relatedTarget)) {
        dropzone.classList.remove('dragover');
    }
}

function handleDrop(e) {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileUpload(files[0]);
    }
}

function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
        handleFileUpload(file);
    }
}

function handleFileUpload(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    // Show progress
    document.getElementById('uploadProgress').classList.remove('d-none');
    const progressBar = document.querySelector('#uploadProgress .progress-bar');
    
    // Simulate progress (you can implement real progress tracking)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        if (progress >= 90) {
            clearInterval(progressInterval);
        }
    }, 100);
    
    fetchWithCSRF('/upload-file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        setTimeout(() => {
            document.getElementById('uploadProgress').classList.add('d-none');
            progressBar.style.width = '0%';
            
            if (data.success) {
                uploadedFileName = data.filename;
                document.getElementById('uploadedFileName').textContent = data.filename;
                document.getElementById('uploadedFileSize').textContent = data.size;
                document.getElementById('uploadedFile').classList.remove('d-none');
                updateEncryptionStatus();
            } else {
                alert('Upload failed: ' + data.message);
            }
        }, 500);
    })
    .catch(error => {
        clearInterval(progressInterval);
        document.getElementById('uploadProgress').classList.add('d-none');
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
    });
}

function removeUploadedFile() {
    if (uploadedFileName) {
        fetchWithCSRF(`/delete-file/${uploadedFileName}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedFileName = '';
                document.getElementById('uploadedFile').classList.add('d-none');
                document.getElementById('fileInput').value = '';
                updateEncryptionStatus();
            } else {
                alert('Failed to delete file: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Delete file error:', error);
            alert('Failed to delete file: ' + error.message);
        });
    }
}

function selectAllRecipients() {
    document.querySelectorAll('input[name="recipients"]').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateEncryptionStatus();
}

function clearAllRecipients() {
    document.querySelectorAll('input[name="recipients"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateEncryptionStatus();
}

function updateEncryptionStatus() {
    const hasFile = uploadedFileName !== '';
    const selectedRecipients = document.querySelectorAll('input[name="recipients"]:checked');
    const hasRecipients = selectedRecipients.length > 0;
    
    const encryptBtn = document.getElementById('encryptBtn');
    const statusDiv = document.getElementById('encryptionStatus');
    
    if (hasFile && hasRecipients) {
        encryptBtn.disabled = false;
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle me-2"></i>
                Ready to encrypt <strong>${uploadedFileName}</strong> for <strong>${selectedRecipients.length}</strong> recipient(s).
            </div>
        `;
    } else if (!hasFile && !hasRecipients) {
        encryptBtn.disabled = true;
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Please upload a file and select at least one recipient to begin encryption.
            </div>
        `;
    } else if (!hasFile) {
        encryptBtn.disabled = true;
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Please upload a file to encrypt.
            </div>
        `;
    } else if (!hasRecipients) {
        encryptBtn.disabled = true;
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Please select at least one recipient.
            </div>
        `;
    }
}

function encryptFile() {
    const selectedRecipients = Array.from(document.querySelectorAll('input[name="recipients"]:checked'))
                                   .map(checkbox => checkbox.value);
    
    if (!uploadedFileName || selectedRecipients.length === 0) {
        alert('Please upload a file and select recipients first.');
        return;
    }
    
    // Show progress
    document.getElementById('encryptionProgress').classList.remove('d-none');
    document.getElementById('encryptBtn').disabled = true;
    
    const formData = new FormData();
    formData.append('filename', uploadedFileName);
    selectedRecipients.forEach(recipient => {
        formData.append('recipients', recipient);
    });
    
    fetchWithCSRF('/encrypt-file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('encryptionProgress').classList.add('d-none');
        
        if (data.success) {
            encryptedFileName = data.encrypted_filename;
            document.getElementById('encryptedFileName').textContent = data.encrypted_filename;
            document.getElementById('encryptedFileSize').textContent = data.size;
            document.getElementById('encryptedFileResult').classList.remove('d-none');
            
            // Reset form
            uploadedFileName = '';
            document.getElementById('uploadedFile').classList.add('d-none');
            document.getElementById('fileInput').value = '';
            clearAllRecipients();
            updateEncryptionStatus();
            
            // Scroll to result
            document.getElementById('encryptedFileResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Encryption failed: ' + data.message);
            document.getElementById('encryptBtn').disabled = false;
        }
    })
    .catch(error => {
        document.getElementById('encryptionProgress').classList.add('d-none');
        document.getElementById('encryptBtn').disabled = false;
        console.error('Encryption error:', error);
        alert('Encryption failed: ' + error.message);
    });
}

function downloadEncryptedFile() {
    if (encryptedFileName) {
        window.open(`/download-file/${encryptedFileName}`, '_blank');
    }
}

function deleteEncryptedFile() {
    if (encryptedFileName && confirm('Are you sure you want to delete the encrypted file?')) {
        fetchWithCSRF(`/delete-file/${encryptedFileName}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                encryptedFileName = '';
                document.getElementById('encryptedFileResult').classList.add('d-none');
            } else {
                alert('Failed to delete file: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Delete file error:', error);
            alert('Failed to delete file: ' + error.message);
        });
    }
}

// Initialize
updateEncryptionStatus();
</script>
{% endblock %}